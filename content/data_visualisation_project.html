<!DOCTYPE html>
<meta charset="utf-8">
<style>
    body { font: 12px sans-serif; background-color:#F9FDFF; }
    .axis path,
    .axis line { fill: none; stroke: black; }
    .line { fill: none; }

    div.tooltip {
        position: absolute;
        text-align: center;
        padding: 5px; 
        font: 12px sans-serif;
        border-radius: 4px;
        pointer-events: none;}
</style>
    <head>
        <title>Data Visualisation Final Project</title>
        <meta name="tags" content="visualisation, UIUC" />
        <meta name="date" content="2018-06-09 22:28" />
        <meta name="modified" content="2018-06-10 20:14" />
        <meta name="category" content="Projects" />
        <meta name="authors" content="Graham Chester" />
        <meta name="summary" content="Short version for index and feeds" />
    </head>
<body>
    <h1 style="text-align:center">Monthly Sales by Product</h1>
    <div style="text-align:center; color: grey;">
        <p>(Hover over or click on data points or legend for effects)</p>
    </div>
</body>

<script src="//d3js.org/d3.v3.min.js"></script>
<script>
    // set margins and dimensions
    var margin = {top: 20, right: 30, bottom: 30, left: 80};
    var width  = 960 - margin.left - margin.right;
    var height = 600 - margin.top  - margin.bottom;

    // format line color
    var prodColour = d3.scale.category10();

    // Setup svg canvas
    var svg = d3.select("body").append("svg")
        .attr("width",  width  + margin.left + margin.right)
        .attr("height", height + margin.top  + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    // set div for the hover over tooltip
    var tooltip = d3.select("body").append("div").attr("class", "tooltip").style("opacity", 0);

    // d3 processing and plotting
    d3.json("static/Task3_data.json", function (error, data) {
        if (error) throw error;

        // refine variable names and types, and find max Sales Amount
        var maxSales = 0;
        dates = []
        data.Sales.forEach(function(d) {
            d.product = d["Product Name"].replace(" ","");
            if (!dates.includes(d.Month)) dates.push(d.Month); // save unique dates for x-axis
            d.amount = +d["Sales Amount (k)"];
            d.profit = +d["Gross Profit (k)"];
            if (d.amount > maxSales) maxSales = d.amount; // remember max(amount) for scaling y-axis
            });

        // set x and y Axes (using ordinal for x due to Firefox/Safari date parsing incompatibility)
        var x = d3.scale.ordinal().domain(dates).rangePoints([0, width]);
        var y = d3.scale.linear().range([height, 0]);
        var xAxis = d3.svg.axis().scale(x).orient("bottom");
        var yAxis = d3.svg.axis().scale(y).orient("left");
        y.domain( [0, maxSales] );

        // define lines based on sales amount
        var line = d3.svg.line()
            .x(function (d) { return x(d.Month); })
            .y(function (d) { return y(d.amount); });

        // reshape data for D3 plotting using d3 nests
        var sales = d3.nest().key(function(d) { return d.product; }).entries(data.Sales);

        // add the x and y axes to canvas
        svg.append("g").call(xAxis)
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height + ")");
        svg.append("g").call(yAxis)
            .attr("class", "y axis").append("text")
            .attr("transform", "rotate(-90)")
            .text("Sales in 1000's").attr("x", -height/2).attr("y", -50); // positon y-axis label in the middle

        // add faint horizontal lines to improve interpretation
        var yScale = d3.scale.linear().domain([0, maxSales]).range([height-1, 1]);
        svg.selectAll("line.horizontalGrid").data(yScale.ticks(5)).enter().append("line").attr({
            "class": "horizontalGrid",
            "x1" : 0,
            "x2" : width,
            "y1" : function(d){ return yScale(d);},
            "y2" : function(d){ return yScale(d);},
            "fill" : "none",
            "shape-rendering" : "crispEdges",
            "stroke" : "#E5E5E5",
            "stroke-width" : "1px"});

        // create product data from sales for plotting
        var product = svg.selectAll(".product")
            .data(sales).enter()
            .append("g")
            .attr("class", function (d) { return d.key });

        // add plot lines
        product.append("path")
            .attr("class", "line")
            .attr("d", function (d) { return line(d.values); })
            .style("stroke", function (d) { return prodColour(d.key); })
            .attr('stroke-width',1.5);

        // add legend text and coloured rectangles
        product.append("text")
            .attr("class", function (d) { return d.key })
            .text(function (d) { return d.key; })
            .attr('x', function(d, i){ return (i*80+width/2+15);}).attr('y', 8)

            // hovering changes cursor to pointer, and back to default when leave
            .on("mouseover", function (d) {
                d3.select(this).style("cursor", "pointer")})
            .on("mouseout", function (d) {
                d3.select(this).style("cursor", "default")})

             // clicking on rectangle highlights line and greys others
            .on("click", function(d) {
                lineClass = d3.select(this).attr("class");
                opacity = d3.select(this).style("opacity");
                if (opacity == 1) {
                    d3.selectAll(".product1").style("opacity", "0.2");
                    d3.selectAll(".product2").style("opacity", "0.2");
                    d3.selectAll(".product3").style("opacity", "0.2");
                    d3.selectAll("."+lineClass).style("opacity", "1");
                    d3.select(this).style("opacity", "0.99");
                } else {
                    d3.selectAll(".product1").style({opacity: 1});
                    d3.selectAll(".product2").style({opacity: 1});
                    d3.selectAll(".product3").style({opacity: 1});
                    d3.select(this).style("opacity", "1");
                }
            });

        // Add legend rectangles
        product.append('rect')
            .attr('x', function(d, i){ return (i*80+width/2);}).attr('y', 0)
            .attr('width', 10).attr('height', 10)
            .attr("class", function (d) { return d.key })
            .style('fill', function (d) { return prodColour(d.key); })

            // hovering changes cursor to pointer, and back to default when leave
            .on("mouseover", function (d) {
                d3.select(this).style("cursor", "pointer")})
            .on("mouseout", function (d) {
                d3.select(this).style("cursor", "default")})

            // clicking on rectangle highlights line and greys others
            .on("click", function(d) {
                lineClass = d3.select(this).attr("class");
                opacity = d3.select(this).style("opacity");
                if (opacity == 1) {
                    d3.selectAll(".product1").style("opacity", "0.2");
                    d3.selectAll(".product2").style("opacity", "0.2");
                    d3.selectAll(".product3").style("opacity", "0.2");
                    d3.selectAll("."+lineClass).style("opacity", "1");
                    d3.select(this).style("opacity", "0.99");
                } else {
                    d3.selectAll(".product1").style({opacity: 1});
                    d3.selectAll(".product2").style({opacity: 1});
                    d3.selectAll(".product3").style({opacity: 1});
                    d3.select(this).style("opacity", "1");
                }
            });

        // create data points and add to product chart data
        var points = product.selectAll("circle").data(function (d) { return d.values; });
        points.enter()
            .append("circle")
            .attr("r", 5)
            .attr("cx", function (d) { return x(d.Month); })
            .attr("cy", function (d) { return y(d.amount); })
            .attr("class", "point")
            .style("fill", function (d) { return((d.profit < 0) ? "lightcoral" : "black"); })

            // add mouse hover over, and hover out
            .on("mouseover", function (d) {
                d3.select(this).style("cursor", "pointer");
                tooltip.transition().duration(300).style("opacity", .9);
                hoverText = d.Month + "<br/>Sales: " + d.amount + "k" + "<br/>Profit: " + d.profit + "k";
                background = (d.profit < 0) ? "lightcoral" : "lightgreen"
                tooltip.html(hoverText).style("left", (d3.event.pageX+5)+"px")
                        .style("top", (d3.event.pageY-30)+"px").style("background", background);})
            .on("mouseout", function (d) {
                d3.select(this).style("cursor", "default");
                tooltip.transition().duration(300).style("opacity", 0);})

            // clicking on point greys out all others, clicking again toggles back
            .on("click", function(d) {
                opacity = d3.select(this).style("opacity");
                if (opacity == 1) {
                    d3.selectAll(".point").style("opacity", "0.15");
                    d3.selectAll(".line").style("opacity", "0.15");
                    d3.select(this).style("opacity", "0.95"); 
                } else {
                    d3.selectAll(".point").style("opacity", "1");
                    d3.selectAll(".line").style("opacity", "1");
                }
            });

    });
</script>
